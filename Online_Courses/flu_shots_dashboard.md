# Flu Shots Dashboard with SQL and Tableau

[Source](https://www.youtube.com/watch?v=3TuayvU1kwU)

---

# First: SQL Basics with Healthcare Data

[Source](https://www.youtube.com/watch?v=ef4CAu-OwvM)

[Create_New_Tables.sql](D:\GitHub\important-reference-repo\Online_Courses\Create_New_Tables.sql) - this is what we downloaded from his github to use to create the sample data

- in pgAdmin 4 (running PostgreSQL), think of the side as a filing cabinet and there are different drawers that represent the databases and in each drawer there are folders including for Schemas

  - there can be multiple schemas within a database
  - that schema can have multiple files in it including functions, aggregates, etc

- to create tables in the postgres database:

  - right click on `Servers > PostgreSQL 17 > Databases > postgres > Schemas > public` and select `Query Tool`
  - you would then past in the sql code or write in the sql code directly that creates tables (ex below)

```sql
CREATE TABLE conditions (
START DATE
,STOP DATE
,PATIENT VARCHAR(1000)
,ENCOUNTER VARCHAR(1000)
,CODE VARCHAR(1000)
,DESCRIPTION VARCHAR(200)
);
```

- now you would be able to see the tables on the left hand side under `public > Tables` and usually it will have a number next to it for how many tables there are

_Data is not real patient data and was generated by the free open source [Synthea](https://synthetichealth.github.io/synthea/)_

Example query with the sample dataset:

```sql
SELECT	*
FROM 	public.encounters
WHERE 	encounterclass = 'inpatient'
	AND	description = 'Admission to surgical department'
	AND stop BETWEEN '2016-01-01 00:00' AND '2016-12-31 00:00';
```

```sql
SELECT description,
	COUNT(*) as count_of_cond -- this is going to return the count of all the distinct type of descriptions and rename the column name as 'count_of_cond'
FROM public.conditions
WHERE description != 'Body mass index 30+ - obesity (finding)' -- this is to exclude one of the descriptions from the findings
GROUP BY description
HAVING COUNT(*) > 20 -- this is going to filter out only the descriptions where the count is higher than 20
ORDER BY COUNT(*) DESC; -- this is for sorting the data from highest count to lowest count
```

```sql
-------------------------------------------------------------------------------------------
-- Write a query that does the following:
-- 1. Lists out number of patients per city in desc order
-- 2. Does not include Boston
-- 3. Must have at least 10 patients from that city * needed to adjust to 10 because my sample data is smaller
-------------------------------------------------------------------------------------------
SELECT city,
	COUNT(*) as num_of_patients
FROM public.patients
WHERE city != 'Boston'
GROUP BY city
HAVING COUNT(*) > 10
ORDER BY COUNT(*) DESC;

```

---

# Flu Shots SQL for Dashboard

Objectives

Come up with flu shots dashboard for 2015 that does the following

1.) Total % of patients getting flu shots stratified by

    a.) Age

    b.) Race

    c.) County (On a map)

    d.) Overall

2.) Running Total of Flu Shots over the course of 2015
3.) Total number of Flu shots given in 2015
4.) A list of Patients that show whether or not they received the flu shots

_Requirements:_
Patients must have been "Active at our hospital"

- for the requirements, we can exclude patients with deathdates, or have not had an encounter in our facility for the past 3 years (using this as an indication they may have moved or are being treated in another facility)

```sql
-- we will join 2 queries together because we don't need all the data from both tables to avoid unncessary columns
WITH active_patients AS
(
	SELECT DISTINCT patient
	FROM encounters AS e
	JOIN patients as pat
		ON e.patient = pat.id
	WHERE start BETWEEN '2013-01-01 00:00' AND '2015-12-31 23:59'
		AND pat.deathdate IS NULL
		AND EXTRACT(MONTH FROM age('2015-12-31',pat.birthdate)) >= 6 -- this is to separate out anyone less than 6 months old
),	-- if there are more than one table expression, you need to use commas separating them

flu_shot_2015 AS	-- after the first time you use the WITH for a table expression, you don't need to use it again for any ones after
(
	SELECT patient, MIN(date) AS earliest_flu_shot_2015		-- there might be some patients who have had multiple flu shots for the year so we are asking to return just the earliest one by date
	FROM immunizations
	WHERE 	code = '140'
		AND date BETWEEN '2015-01-01 00:00' AND '2015-12-31 00:00'
	GROUP BY patient
)


SELECT	 pat.birthdate
		,pat.race
		,pat.county
		,pat.id
		,pat.first
		,pat.last
		,flu.earliest_flu_shot_2015
		,CASE WHEN flu.patient IS NOT NULL THEN 1	-- this is to create a binary column that will quickly let us add up how many people actually got the flu shot in 2015 vs those who did not
		ELSE 0
		END AS flu_shot_2015
FROM patients as pat
LEFT JOIN flu_shot_2015 as flu
	ON pat.id = flu.patient
WHERE 1=1
	AND pat.id IN (SELECT patient FROM active_patients)
```

---

# Tableau Dashboard

- once we import our data, there are a few additional variables we need to create
  - Age Range (from the birthdate)
